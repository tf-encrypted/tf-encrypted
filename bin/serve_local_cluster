#!/bin/bash
DIRECTORY=`dirname $0`

# Default configuration: 5 servers
TFE_NODE_NAME=server0 TFE_MASTER_ADDRESS=0.0.0.0:4000 TFE_SERVER0_ADDRESS=0.0.0.0:4441 TFE_SERVER1_ADDRESS=0.0.0.0:4442 TFE_CRYPTO_PRODUCER_ADDRESS=0.0.0.0:4443 TFE_WEIGHTS_PROVIDER_ADDRESS=0.0.0.0:4444 $DIRECTORY/serve &
PID1=$!
TFE_NODE_NAME=server1 TFE_MASTER_ADDRESS=0.0.0.0:4000 TFE_SERVER0_ADDRESS=0.0.0.0:4441 TFE_SERVER1_ADDRESS=0.0.0.0:4442 TFE_CRYPTO_PRODUCER_ADDRESS=0.0.0.0:4443 TFE_WEIGHTS_PROVIDER_ADDRESS=0.0.0.0:4444 $DIRECTORY/serve &
PID2=$!
TFE_NODE_NAME=crypto_producer TFE_MASTER_ADDRESS=0.0.0.0:4000 TFE_SERVER0_ADDRESS=0.0.0.0:4441 TFE_SERVER1_ADDRESS=0.0.0.0:4442 TFE_CRYPTO_PRODUCER_ADDRESS=0.0.0.0:4443 TFE_WEIGHTS_PROVIDER_ADDRESS=0.0.0.0:4444 $DIRECTORY/serve &
PID3=$!
TFE_NODE_NAME=weights_provider TFE_MASTER_ADDRESS=0.0.0.0:4000 TFE_SERVER0_ADDRESS=0.0.0.0:4441 TFE_SERVER1_ADDRESS=0.0.0.0:4442 TFE_CRYPTO_PRODUCER_ADDRESS=0.0.0.0:4443 TFE_WEIGHTS_PROVIDER_ADDRESS=0.0.0.0:4444 $DIRECTORY/serve &
PID4=$!

echo "to kill the 4 servers use: kill $PID1 $PID2 $PID3 $PID4"
sleep 2

# API
GRPC_VERBOSITY=DEBUG TFE_BATCH_SIZE=5 TFE_NODE_NAME=master TFE_MASTER_ADDRESS=0.0.0.0:4000 TFE_SERVER0_ADDRESS=0.0.0.0:4441 TFE_SERVER1_ADDRESS=0.0.0.0:4442 TFE_CRYPTO_PRODUCER_ADDRESS=0.0.0.0:4443 TFE_WEIGHTS_PROVIDER_ADDRESS=0.0.0.0:4444 $DIRECTORY/serve --model_name 2lfc
