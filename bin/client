#!/usr/bin/env python

from typing import List, Any, Optional

import time
import threading
import argparse
import json
import requests
import numpy as np


class Client():
    def __init__(self, host: str, port: int) -> None:
        self.host = host
        self.port = port
        self.base_url = "http://%s:%d" % (self.host, self.port)

    def send_inputs(self, input_data: List[Any]) -> str:
        r = requests.post("%s/predict" % self.base_url, json=input_data)
        output_data = json.loads(r.text)

        return output_data['request_id']

    def send_random_inputs(self, shape: List[int]) -> str:
        input_data = np.random.standard_normal(shape).tolist()
        r = requests.post("%s/predict" % self.base_url, json=input_data)
        output_data = json.loads(r.text)

        return output_data['request_id']

    def poll(self, request_id: str) -> str:
        output_data = None

        def polling(request_id: str)-> Optional[str]:
            i = 0
            while i < 60:
                i += 1
                # Keep polling until we have an answer
                r = requests.post("%s/poll" % self.base_url, json=request_id)
                output_data = r.text
                print(output_data)
                if output_data is not None:
                    return output_data
                else:
                    time.sleep(5)

            return None

        thread = threading.Thread(target=polling, args=(request_id))
        thread.start()
        thread.join()
        if output_data is None:
            return None
        else:
            return json.loads(output_data)


def main(config):
    c = Client(config.host, config.port)

    if config.poll:
        request_id = config.request_id
        if request_id is None:
            print("you need to provide a request_id")
            return

        output = c.poll(request_id)
        print(output)
    else:
        shape = list(map(lambda x: int(x), config.shape.split(',')))
        request_id = c.send_random_inputs(shape)
        print(request_id)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--host", type=str, default="localhost", help="increase output verbosity")
    parser.add_argument(
        '--port', type=int, default=5000, help='port API endpoint for the prediction')
    parser.add_argument(
        '--poll', type=bool, default=False, help='Perform pooling')
    parser.add_argument(
        '--request_id', type=str, help='id used to poll an output')
    parser.add_argument(
        '--shape', type=str, default="1", help='shape as a string array: 1,2,3')
    args = parser.parse_args()

    main(args)
